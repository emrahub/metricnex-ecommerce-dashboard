# MetricNex E‑commerce Dashboard — Change Log (2025-08-28)

Bu doküman; login, Google Analytics entegrasyonu, veri kaynağı kalıcılığı ve arayüz iyileştirmeleriyle ilgili yapılan çalışmaların özetidir. Öncelikli bilgiler portlar/URL’ler ve çalıştırma adımlarıdır.

## Portlar ve URL’ler
- Backend API: `http://localhost:3000`
  - Health: `GET /health`
  - Auth: `POST /api/auth/login`, `GET /api/auth/me`
  - Google Analytics raporları:
    - `POST /api/analytics/google-analytics/report`
    - `GET  /api/analytics/google-analytics/reports/weekly-sessions`
    - `GET  /api/analytics/google-analytics/reports/country-traffic`
    - `GET  /api/analytics/google-analytics/reports/device-category`
    - `GET  /api/analytics/google-analytics/reports/traffic-sources`
  - Data Sources: `GET/POST/PUT/DELETE /api/data-sources`
- Frontend (Vite): `http://localhost:3001`
  - Login: `http://localhost:3001/login`
  - GA sayfası: `http://localhost:3001/google-analytics`
  - Settings → Data Sources: `http://localhost:3001/settings`

## Nasıl Çalıştırılır
- Geliştirme için: kök dizinde `npm run dev`
  - Backend ve Frontend arka planda başlar; loglar `server-logs/` altında.
  - Vite dev server proxy’si `/api` isteklerini 3000’e yönlendirir.
- Not: `scripts/dev.sh` dev ortamında login’i kolaylaştırmak için `DISABLE_AUTH=true` ile başlatır. Analytics için mock devre dışı, gerçek GA verisi kullanılır.

## Yapılan Önemli Değişiklikler

### 1) Login/Demo Girişi
- `backend/src/routes/auth.ts`
  - Demo/dev amaçlı login kısa devresi eklendi (env’e bağlı). JWT için dev fallback eklendi.
- `scripts/dev.sh`
  - Dev’de `DISABLE_AUTH=true` set edilir; böylece hızlı giriş/test mümkün olur.

### 2) Google Analytics (Gerçek Veri)
- Mock veri tamamen kaldırıldı; tüm GA endpoint’leri gerçek Google Analytics Data API’yi çağırır.
  - Dosya: `backend/src/routes/analytics.ts`
- GA servisinde kayıtlı veri kaynağı dosyasından (aşağıda) doğru GA kaydı seçimi geliştirildi:
  - Dosya: `backend/src/services/googleAnalytics.ts`
  - Token + Property ID dolu olan GA kaydı öncelikli seçilir.
- GA sayfası artık gerçek verileri gösterir; Özel Raporlar Excel/CSV olarak `uploads/reports/` altına kaydedilir.

### 3) Data Sources (Kalıcılık ve Güvenlik)
- Kalıcı dosya yolu: `backend/uploads/data/data-sources.json`
  - API: `GET /api/data-sources` yalnızca kullanıcı eklediği kayıtları döner; eski “seed_*” kayıtları listeden gizlendi.
  - Dosya: `backend/src/routes/dataSources.ts`
- Kaydetme sonrası otomatik canlı test: Frontend kaydı oluşturduktan/güncelledikten sonra “live test” çalıştırır; sonuçla `status` (yeşil/kırmızı) güncellenir.
  - Dosya: `frontend/src/features/data-sources/DataSourceSettings.tsx`
- Open (detay) görünümünde gizli alanlar maskelenir (token vs. gösterilmez).
  - Dosya: `frontend/src/pages/DataSourceDetail.tsx`

### 4) Diğer Başlıklar
- Sağlık/Loglar: `server-logs/backend.log` ve `server-logs/frontend.log` hızlı tanı için kullanıma hazır.
- Raporlar: `uploads/reports/` altına Excel/CSV üretilir.

## GA4 Yapılandırma Adımları (Özet)
1) Google Cloud → Service Account JSON anahtarı oluşturun.
2) GA4 → Admin → Property Access Management → Service Account e‑postasını ekleyin (Viewer/Analyst).
3) Settings → Data Sources → Add → Google Analytics
   - Property ID: Sadece sayılar (örn. `349428903`).
   - Service Account (JSON/Base64): Tam JSON veya base64.
4) Save → otomatik “Live Test” → durum “connected” (yeşil) olmalı.

## Güvenlik Notları
- Open görünümünde `apiToken` maskelenir (`••••••••`).
- Anahtarları paylaşmayın; sızıntı şüphesinde Google Cloud’da key’i iptal edip yenisini üretin.

## Değişen Dosyalar (Seçme)
- Backend
  - `backend/src/routes/analytics.ts` — GA mock kaldırıldı, gerçek API çağrıları.
  - `backend/src/services/googleAnalytics.ts` — GA kaydı seçim mantığı iyileştirildi.
  - `backend/src/routes/dataSources.ts` — seed kayıtlar listeden gizlendi; kalıcılık/doğrulama.
  - `backend/src/routes/auth.ts` — demo login/fallback geliştirmeleri.
  - `backend/src/app.ts` — dev çalıştırma kolaylıkları.
  - `scripts/dev.sh` — dev env ayarları (portlar, env’ler, loglar).
- Frontend
  - `frontend/src/features/data-sources/DataSourceSettings.tsx` — kaydetme sonrası live test ve durum güncelleme.
  - `frontend/src/pages/DataSourceDetail.tsx` — detay görünümünde sırları maskeli göster.

## Çalışma Durumu (28-08-2025)
- Backend: 3000 portunda çalışır, `GET /health` → OK.
- Frontend: 3001 portunda çalışır.
- GA4 bağlantısı: Test SUCCESS; rapor endpoint’leri gerçek veri döndürüyor.

